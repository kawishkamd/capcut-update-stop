name: Build CapCut Update Blocker

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
    
    - name: Build Windows executable
      run: |
        pyinstaller --onefile --name "CapCut_Update_Blocker" --noconsole --uac-admin --icon=NONE --version-file version_info.txt capcut.py
    
    - name: Verify build
      run: |
        if (Test-Path "dist/CapCut_Update_Blocker.exe") {
          Write-Host "âœ… Build successful!"
          Write-Host "File size: $((Get-Item dist/CapCut_Update_Blocker.exe).Length / 1MB) MB"
        } else {
          Write-Host "âŒ Build failed - exe not found"
          exit 1
        }
      shell: powershell
    
    - name: Get version info
      id: version
      run: |
        echo "date=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
      shell: bash
    
    - name: Upload executable as artifact
      uses: actions/upload-artifact@v4
      with:
        name: CapCut_Update_Blocker_Windows
        path: dist/CapCut_Update_Blocker.exe
        retention-days: 90
    
    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/CapCut_Update_Blocker.exe
        body: |
          ## CapCut Update Blocker v${{ github.ref_name }}
          
          ### Features
          - ğŸ”’ Locks CapCut to version 1.5.0
          - ğŸš« Blocks all auto-updates
          - ğŸ“¥ Downloads CapCut 1.5.0 if not installed
          - âœ… Works on Windows 7, 8, 10, 11
          
          ### How to Use
          1. Download `CapCut_Update_Blocker.exe`
          2. Right-click â†’ Run as Administrator
          3. Follow the on-screen instructions
          
          ### Warnings
          âš ï¸ Use at your own risk
          âš ï¸ May violate CapCut's Terms of Service
          âš ï¸ No security updates will be received
          
          ### Support
          If you encounter issues, please open an issue on GitHub.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
